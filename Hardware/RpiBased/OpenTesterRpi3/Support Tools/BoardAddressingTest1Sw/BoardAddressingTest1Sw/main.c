/*
 * main.c
 *
 * Created: 2/10/2022 9:19:50 PM
 *  Author: Henrik B. Sørensen
 */ 

#include <xc.h>
#include <avr/io.h>
#include <util/delay.h>
#include <stdbool.h>


#define EMPTY_ADDRESS 0xFF

#define SHORT_FLASH_ON   125
#define SHORT_FLASH_OFF  375
#define MEDIUM_FLASH_ON  250
#define MEDIUM_FLASH_OFF 250
#define LONG_FLASH_ON    375
#define LONG_FLASH_OFF   125

#define FLASH_UNCONFIGURED 1
#define FLASH_CONFIGURING  2
#define FLASH_CONFIGURED   3

#define FLASH_UNCONFIGURED_COUNT 10
#define FLASH_CONFIGURING_COUNT  1
#define FLASH_CONFIGURED_COUNT   5

#define SHORT_BUTTON_PRESS 40
#define LONG_BUTTON_PRESS  100

#define ADR_LIMIT 15

#define ENABLED  0
#define DISABLED 1


// Initialize Ports
//
void initializePorts()
{
	PORTA = (1 << PB2);
	PORTB = (1 << PA2);
}


// Tests if the button is pressed and returns the time (10-1000+ ms), it was pressed. 
// 0 if not pressed
//
uint16_t buttonIsPressed()
{
	uint16_t duration = 0;
	return duration;
}


// Read address from EEPROM
// 
uint8_t getAddress()
{
	uint8_t adr = 0;
	return adr;
}


// Set address in EEPROM
//
bool setAddress(uint8_t adr)
{
	// Write to EERPOM
	

	uint8_t address = getAddress();
	return address == adr;
}


// Reads the address lines
//
uint8_t getAddressFromLines()
{
	return 0x00;
}


// Flash LED
//
void flashLED(uint8_t pattern)
{
	uint8_t on = SHORT_FLASH_ON;
	uint8_t off = SHORT_FLASH_OFF;
	uint8_t count = FLASH_UNCONFIGURED_COUNT;

	switch(pattern)
	{
		case FLASH_CONFIGURING:
			on = MEDIUM_FLASH_ON;
			off = MEDIUM_FLASH_OFF;
			count = FLASH_CONFIGURING_COUNT;
			break;

		case FLASH_CONFIGURED:
			on = LONG_FLASH_ON;
			off = LONG_FLASH_OFF;
			count = FLASH_CONFIGURED_COUNT;
			break;

		default: 
			on = SHORT_FLASH_ON;
			off = SHORT_FLASH_OFF;
			count = FLASH_UNCONFIGURED_COUNT;
			break;		
	}	
	for(uint8_t n=0; n<count; n++)
	{
		// LED ON
		_delay_ms(on);
		// LED_OFF
		_delay_ms(off);
	}
}


// Set pin
//
void setPin(uint8_t val)
{
	// Set pin value
}





// Check configuration state of the chip and if configured test the address against stored value
//
int main(void)
{
	uint8_t state = FLASH_UNCONFIGURED;
	
	initializePorts();

	// Get address
	uint8_t adr = getAddress();	
	
	// If uninitialized begin initialization cycle
	if (EMPTY_ADDRESS == adr)
	{
		uint8_t adrSetting = 1;
		
		// Until configured read button and flash LED
		while(FLASH_CONFIGURED != state)
		{
			uint16_t buttonDuration = buttonIsPressed();

			if (buttonDuration >= LONG_BUTTON_PRESS)
			{
				if ( FLASH_UNCONFIGURED == state)
				{
					state = FLASH_CONFIGURING;
				}
				else if(FLASH_CONFIGURING == state)
				{
					state = FLASH_CONFIGURED;
				}
			}
			else if(buttonDuration <= SHORT_BUTTON_PRESS)
			{
				adrSetting++;
				adrSetting = adrSetting % ADR_LIMIT;
			}	


			// Show status unless configuring
			if (FLASH_CONFIGURING != state)
			{
				flashLED(state);
			}
			// If configuring, then flash the address on the LED
			else
			{
				for(uint8_t n=0; n<adrSetting; n++)
				{
					// LED ON
					_delay_ms(MEDIUM_FLASH_ON);
					// LED OFF
					_delay_ms(MEDIUM_FLASH_OFF);
				}
				
				_delay_ms(1000);
			}
		}
	}
	
    while(1)
    {
		uint8_t input = getAddressFromLines();
		setPin(input == adr ? ENABLED : DISABLED);
		
    }
}